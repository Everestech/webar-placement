<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR: Colocación de Objetos (Final Fix)</title>
    
    <!-- Tailwind CSS para estilos de UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librerías de WebAR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>

    <style>
        /* Estilos específicos para la UI */
        #status-message {
            z-index: 1000;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            text-align: center;
            font-family: 'Inter', sans-serif;
            transition: opacity 0.3s ease;
        }

        /* Estilo para el overlay de inicio */
        #ar-overlay {
            z-index: 1010;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            backdrop-filter: blur(5px);
        }

        /* Asegura que la escena ocupe toda la pantalla */
        a-scene {
            height: 100vh;
            width: 100vw;
        }

        /* Animación de pulso para el cursor */
        .cursor-sphere {
            opacity: 0.8;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.2);
            }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- 
        ============================================================
        Componente JavaScript para la Lógica AR con WebXR nativo
        ============================================================
    -->
    <script>
        // Componente para manejar la lógica del Hit-Testing y colocación
        AFRAME.registerComponent('webxr-placement-logic', {
            init: function () {
                this.sceneEl = this.el;
                this.statusEl = document.getElementById('status-message');
                this.cursorEl = document.getElementById('ar-cursor');
                this.objectCount = 0;
                this.hitTestState = false; 
                this.hitTestReady = false; 

                // Clonar el objeto cursor (template) y usarlo como marcador
                this.template = document.getElementById('object-template').cloneNode(true);
                this.template.id = 'template-clone';
                this.cursorEl.appendChild(this.template);
                this.template.setAttribute('visible', 'false');

                // 1. Escuchar cuando el modo AR se activa
                this.sceneEl.addEventListener('enter-vr', (evt) => {
                    if (this.sceneEl.is('ar-mode')) {
                        console.log('DEBUG: ENTER-VR OK. AR mode activo. Inicializando listeners con MouseUp.');
                        this.hitTestReady = true;
                        this.statusEl.textContent = '¡Cámara activada! Mueva lentamente el móvil para escanear el suelo y detectar superficies.';
                        
                        // Usamos mouseup en el canvas, ya que el evento 'click' suele ser bloqueado por WebXR.
                        const canvas = this.sceneEl.canvas;
                        if (canvas) {
                            canvas.addEventListener('mouseup', this.placeObject.bind(this));
                            console.log('DEBUG: Listener "mouseup" adjuntado al Canvas.');
                        } else {
                            console.error('DEBUG: ERROR - Canvas no encontrado.');
                        }
                    }
                });

                // 2. Evento continuo de WebXR: ¿Dónde está la superficie?
                this.sceneEl.addEventListener('ar-hit-test-result', (evt) => {
                    if (!this.hitTestReady) return;

                    if (evt.detail.intersection) {
                        const position = evt.detail.intersection.point;
                        
                        // Mueve el cursor a la posición detectada
                        this.template.setAttribute('position', position);
                        this.template.setAttribute('visible', 'true');
                        this.statusEl.textContent = 'Superficie LISTA. Toque la pantalla para colocar.';
                        this.hitTestState = true;
                    } else {
                        // No hay intersección
                        this.template.setAttribute('visible', 'false');
                        this.statusEl.textContent = 'Mueva lentamente el móvil para escanear y encontrar superficies...';
                        this.hitTestState = false;
                    }
                });

                // 3. Manejo de errores y sesión AR
                this.sceneEl.addEventListener('ar-hit-test-unavailable', function () {
                    console.error('DEBUG: ERROR DE AR. El hit-test no está disponible.');
                    this.statusEl.textContent = 'ERROR: Detección de superficie no disponible. Asegúrese de tener ARCore/ARKit en su móvil.';
                    this.hitTestReady = false;
                }.bind(this));

                this.sceneEl.addEventListener('ar-session-start', () => {
                    console.log('DEBUG: Sesión AR iniciada. Activando Hit-Test...');
                    this.sceneEl.setAttribute('ar-hit-test', 'doHitTest: true');
                });
            },
            
            // Función para colocar el objeto 3D
            placeObject: function(evt) {
                // Si el evento vino del botón de A-Frame (la UI), lo ignoramos.
                if (evt.target.id === 'vr-button') return;
                
                evt.preventDefault(); 
                
                // Mantenemos el log de depuración para confirmar que se activa
                console.log('DEBUG: --- ¡EVENTO TÁCTIL CAPTURADO (MouseUp)! ---'); 
                
                // Si tienes abierto el DevTools, el debugger se detendrá aquí:
                // debugger; 

                console.log(`DEBUG: hitTestReady=${this.hitTestReady}, hitTestState=${this.hitTestState}`);

                // 4. Lógica de colocación
                if (this.hitTestState && this.hitTestReady) {
                    const newObject = document.createElement('a-entity');
                    const cursorPosition = this.template.getAttribute('position');
                    
                    // Configuración del objeto
                    newObject.setAttribute('geometry', 'primitive: box; height: 0.2; width: 0.2; depth: 0.2');
                    newObject.setAttribute('material', 'color: #3b82f6; opacity: 0.9');
                    newObject.setAttribute('position', `${cursorPosition.x} ${cursorPosition.y + 0.1} ${cursorPosition.z}`); 
                    newObject.setAttribute('shadow', '');
                    newObject.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
                    
                    this.sceneEl.appendChild(newObject);
                    this.objectCount++;
                    this.statusEl.textContent = `Objeto ${this.objectCount} colocado. Siga escaneando.`;
                } else if (this.hitTestReady) {
                    this.statusEl.textContent = '¡No hay superficie detectada! Mueva su móvil para escanear.';
                }
            }
        });

        // Lógica para iniciar la sesión AR al hacer clic en el botón
        function startAR() {
            const scene = document.getElementById('ar-scene');
            const overlay = document.getElementById('ar-overlay');
            const statusEl = document.getElementById('status-message');
            
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                statusEl.textContent = 'Activando cámara y detección de superficies...';
                scene.enterAR();
            }, 300); 
        }

        // Configuración inicial de A-Frame
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('start-ar-button').addEventListener('click', startAR);
        });
    </script>

    <!-- 
        ============================================================
        Estructura de la Escena A-Frame (El "Mundo 3D")
        ============================================================
    -->
    <a-scene 
        id="ar-scene"
        embedded 
        webxr-placement-logic 
        renderer="logarithmicDepthBuffer: true; antialias: true; outputEncoding: sRGB"
        vr-mode-ui="enabled: false"
        
        <!-- *** CAMBIO CRÍTICO AQUÍ: Eliminación de corchetes y limpieza de espacios *** -->
        webxr="requiredFeatures: hit-test,local-floor; 
               optionalFeatures: dom-overlay,unmanaged-fading; 
               referenceSpaceType: local-floor">
        
        <!-- Luces -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8; castShadow: true" position="-1 2 1"></a-entity>
        
        <!-- Cámara -->
        <a-camera user-height="0"></a-camera>

        <!-- EL CURSOR DE PUNTERÍA AR -->
        <a-entity 
            id="ar-cursor" 
            position="0 0 -0.5">
            
            <a-entity 
                id="object-template"
                geometry="primitive: torus; radius: 0.05; radiusTubular: 0.005; segmentsRadial: 16; segmentsTubular: 12"
                material="color: #4ade80; shader: flat"
                rotation="90 0 0" 
                class="cursor-sphere">
            </a-entity>
        </a-entity>

    </a-scene>

    <!-- 
        ============================================================
        INTERFAZ DE USUARIO (UI)
        ============================================================
    -->

    <div id="ar-overlay" class="transition duration-300 ease-in-out">
        <div class="p-6 max-w-sm bg-white rounded-xl shadow-2xl space-y-4 transform scale-100 md:scale-110">
            <h1 class="text-2xl font-bold text-gray-900">Iniciar AR</h1>
            <p class="text-gray-600">Esta versión utiliza la función WebXR nativa para la máxima compatibilidad.</p>
            <p class="text-sm text-red-500 font-semibold">Toca el botón. Necesitarás mover el móvil para escanear el entorno.</p>
            <button 
                id="start-ar-button" 
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg transform hover:scale-105">
                INICIAR REALIDAD AUMENTADA
            </button>
        </div>
    </div>

    <div id="status-message" class="text-sm rounded-t-lg shadow-2xl">
        Esperando inicio de AR...
    </div>

</body>
</html>
