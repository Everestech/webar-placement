<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Universal: Colocación de Neil Armstrong</title>
    
    <!-- 
        ADVERTENCIA: Tailwind CDN (https://cdn.tailwindcss.com) NO es recomendado para producción, 
        pero se usa aquí para mantener el código en un solo archivo.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
        Three.js para renderizado 3D (para Android/WebXR). 
        NOTA: La advertencia "Multiple instances of Three.js" es esperada, ya que 
        Model Viewer (para iOS/Fallback) también incluye su propia instancia de Three.js.
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- GLTFLoader para cargar el modelo 3D (ESENCIAL para Android/WebXR) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <!-- Model Viewer para iOS Quick Look y Fallback (ESENCIAL para iOS) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/1.12.0/model-viewer.min.js"></script>

    <style>
        /* Estilos generales y UI */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; height: 100vh; width: 100vw; overflow: hidden; }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Overlay para el botón de inicio */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }

        /* Mensaje de estado en la parte inferior */
        #status-message {
            z-index: 1000;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* Estilo para el cargando */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- Mensaje de estado -->
    <div id="status-message">
        Cargando WebAR...
    </div>

    <!-- Overlay de inicio con botones de detección dinámica -->
    <div id="start-overlay">
        <h1 class="text-2xl font-bold text-white mb-6">Colocación de Neil Armstrong en AR</h1>
        
        <!-- Botón para Android/WebXR -->
        <button 
            id="ar-button-android"
            onclick="initAR()"
            class="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-xl transition duration-200 transform hover:scale-105 mb-4"
        >
            INICIAR AR (Android/WebXR)
        </button>

        <!-- Model Viewer para iOS Quick Look y Fallback -->
        <model-viewer 
            src="https://modelviewer.dev/shared-assets/models/NeilArmstrong.glb" 
            alt="Modelo de Neil Armstrong" 
            ar
            ar-modes="webxr quick-look scene-viewer"
            ar-placement="floor"
            camera-controls
            shadow-intensity="1"
            style="width: 0; height: 0; opacity: 0;"
            id="model-viewer-ios"
        >
        </model-viewer>
        
        <button 
            id="ar-button-ios"
            onclick="document.getElementById('model-viewer-ios').activateAR()"
            class="hidden px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-xl transition duration-200 transform hover:scale-105"
        >
            INICIAR AR (iOS/Quick Look)
        </button>

        <p class="mt-4 text-gray-300 text-sm" id="platform-info">Detectando plataforma...</p>
    </div>

    <!-- 
        ============================================================
        Script: Lógica de WebXR Pura + Three.js + Detección
        ============================================================
    -->
    <script>
        // --- Constante del modelo de Neil Armstrong (URL ÚNICA) ---
        const MODEL_URL = "https://modelviewer.dev/shared-assets/models/NeilArmstrong.glb";
        
        // Variables de Three.js y WebXR
        let scene, camera, renderer, reticle;
        let xrSession = null;
        let xrRefSpace = null;
        let xrHitTestSource = null;

        let statusMessageEl;
        let objectCount = 0;
        let armstrongModel = null;
        
        // --- Detección de Plataforma ---
        function isIOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        }

        // --- 0. Carga del Modelo GLTF (Solo necesario para WebXR/Android) ---
        function loadArmstrongModel() {
            statusMessageEl.innerHTML = '<span class="loader"></span> Cargando modelo 3D (Neil Armstrong)...';
            const loader = new THREE.GLTFLoader();
            
            loader.load(MODEL_URL, (gltf) => {
                armstrongModel = gltf.scene;
                armstrongModel.scale.set(0.2, 0.2, 0.2); 
                armstrongModel.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });
                statusMessageEl.textContent = 'Listo para iniciar AR.';
            }, 
            (xhr) => {
                const percent = Math.round(xhr.loaded / xhr.total * 100);
                statusMessageEl.innerHTML = `<span class="loader"></span> Cargando modelo 3D (${percent}%)...`;
            },
            (error) => {
                console.error('Error al cargar el modelo GLTF:', error);
                statusMessageEl.textContent = 'ERROR: No se pudo cargar el modelo 3D.';
                document.getElementById('ar-button-android').disabled = true;
            });
        }

        // --- 1. Inicialización de Three.js y Detección de Plataforma ---
        function initThree() {
            const isApple = isIOS();
            statusMessageEl = document.getElementById('status-message');
            const androidButton = document.getElementById('ar-button-android');
            const iosButton = document.getElementById('ar-button-ios');
            const platformInfo = document.getElementById('platform-info');

            if (isApple) {
                // Configuración de la UI para iOS (Quick Look)
                androidButton.style.display = 'none';
                iosButton.classList.remove('hidden');
                statusMessageEl.textContent = 'Usando Quick Look de iOS. Toque "INICIAR AR" y luego el ícono AR.';
                platformInfo.textContent = 'Plataforma: iOS (iPhone/iPad). Se usa Model Viewer.';
                return;
            }

            // Configuración de la UI para Android/WebXR
            platformInfo.textContent = 'Plataforma: Android/Otro. Se usa WebXR (Three.js).';
            iosButton.style.display = 'none'; 
            loadArmstrongModel();

            // Inicialización de Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.xr.enabled = true; // Habilitar WebXR
            document.body.appendChild(renderer.domElement);
            
            // Iluminación y Sombras
            const light = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(light);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(0, 5, 2);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            renderer.shadowMap.enabled = true; 

            // Retículo
            const geometry = new THREE.RingGeometry(0.04, 0.05, 32);
            const material = new THREE.MeshBasicMaterial({ color: 0x4ade80, side: THREE.DoubleSide });
            reticle = new THREE.Mesh(geometry, material);
            reticle.rotation.x = Math.PI / 2; 
            reticle.visible = false;
            scene.add(reticle);

            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            if (xrSession || isIOS()) return; // Ignorar si XR está activo
            
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- 2. Iniciación de WebXR (Llamada por el botón de Android) ---
        async function initAR() {
            if (isIOS() || !armstrongModel) {
                if (!armstrongModel) statusMessageEl.textContent = 'Aún cargando el modelo... espere un momento.';
                return; 
            }

            if (!navigator.xr) {
                statusMessageEl.textContent = 'WebXR no soportado en este dispositivo.';
                return;
            }

            try {
                renderer.xr.setReferenceSpaceType('local-floor'); 
                
                xrSession = await navigator.xr.requestSession('immersive-ar', { 
                    requiredFeatures: ['local-floor', 'hit-test'] 
                });

                renderer.xr.setSession(xrSession);
                xrRefSpace = await xrSession.requestReferenceSpace('local-floor');
                const xrViewerSpace = await xrSession.requestReferenceSpace('viewer');
                xrHitTestSource = await xrSession.requestHitTestSource({ space: xrViewerSpace });
                
                document.getElementById('start-overlay').style.display = 'none';
                
                // INICIO DEL BUCLE DE ANIMACIÓN DE WEBXR
                renderer.setAnimationLoop(onXRFrame); 
                
                xrSession.addEventListener('select', placeObject);
                xrSession.addEventListener('end', onXRSessionEnd);

                statusMessageEl.textContent = 'Escaneando superficie... Mueva el móvil lentamente.';

            } catch (e) {
                console.error('ERROR al iniciar WebXR AR:', e);
                statusMessageEl.textContent = `Error AR: ${e.name}. Su dispositivo no soporta WebXR. Use el botón de iOS/Quick Look como alternativa.`;
                
                document.getElementById('ar-button-android').style.display = 'none';
                document.getElementById('ar-button-ios').classList.remove('hidden');
            }
        }

        // --- 3. Bucle de Renderizado de WebXR (Solo Android) ---
        // ESTA FUNCIÓN ES LLAMADA AUTOMÁTICAMENTE POR EL XR RUNTIME.
        function onXRFrame(time, frame) {
            // Lógica para Hit Test
            if (xrHitTestSource && xrRefSpace && frame) {
                const hitTestResults = frame.getHitTestResults(xrHitTestSource);

                if (hitTestResults.length > 0) {
                    reticle.visible = true;
                    statusMessageEl.textContent = 'Superficie detectada (cursor verde). Toque para colocar a Neil Armstrong.';
                    
                    const pose = hitTestResults[0].getPose(xrRefSpace);
                    if (pose) {
                        reticle.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                    }
                } else {
                    reticle.visible = false;
                    statusMessageEl.textContent = 'Mueva el móvil para escanear y encontrar superficies...';
                }
            }
            
            // RENDERIZADO: DEBE SER LA ÚNICA LLAMADA A RENDER DENTRO DE ESTE BUCLE.
            renderer.render(scene, camera);
        }

        // --- 4. Colocación de Objetos (Solo Android/WebXR) ---
        function placeObject() {
            if (!xrSession || !reticle.visible || !armstrongModel) {
                statusMessageEl.textContent = 'No se puede colocar: esperando modelo/superficie.';
                return;
            }

            const position = reticle.position;
            const newModel = armstrongModel.clone();
            
            newModel.position.set(position.x, position.y, position.z); 
            
            scene.add(newModel);
            objectCount++;
            statusMessageEl.textContent = `¡Neil Armstrong #${objectCount} colocado! Toque la pantalla para añadir más.`;
        }
        
        // --- 5. Manejo de Fin de Sesión (Solo Android/WebXR) ---
        function onXRSessionEnd() {
            // IMPORTANTE: Detener el bucle de animación de WebXR
            renderer.setAnimationLoop(null); 
            
            xrSession = null;
            xrRefSpace = null;
            xrHitTestSource = null;
            
            if (reticle) {
                reticle.visible = false;
            }
            document.getElementById('start-overlay').style.display = 'flex';
            statusMessageEl.textContent = 'Sesión AR terminada. Presione INICIAR AR para comenzar de nuevo.';
        }

        // Iniciar al cargar la ventana
        window.onload = function() {
            initThree(); // Llama a la inicialización dinámica de plataforma
            // Se ha eliminado el bucle 'animateObjects' para evitar conflictos con WebXR.
        };
    </script>

</body>
</html>
