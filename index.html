<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR: Seguimiento de Imagen y Fallback</title>
    
    <!-- Tailwind CSS para estilos de UI (Solo para desarrollo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js para renderizado 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- GLTFLoader para cargar el modelo 3D -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <!-- Model Viewer para iOS Quick Look y Fallback -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/1.12.0/model-viewer.min.js"></script>

    <style>
        /* Estilos generales y UI */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; height: 100vh; width: 100vw; overflow: hidden; }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Overlay para el botón de inicio */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        /* Mensaje de estado en la parte inferior */
        #status-message {
            z-index: 1000;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* Estilo del spinner de carga */
        .loader {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- Mensaje de estado -->
    <div id="status-message">
        Cargando WebAR...
    </div>

    <!-- Overlay de inicio con botones de detección dinámica -->
    <div id="start-overlay">
        <h1 class="text-2xl font-bold text-white mb-6">AR: Colocación sobre Foto o Plano</h1>
        <p class="text-gray-300 mb-6 text-sm max-w-sm">
            Intenta primero el Seguimiento de Imagen. Si la cámara no abre, usa el modo "Detección de Plano Simple".
        </p>
        
        <!-- Botón 1: Android/WebXR Image Tracking (Avanzado) -->
        <button 
            id="ar-button-image-tracking"
            onclick="initAR('image-tracking')"
            class="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-xl transition duration-200 transform hover:scale-105 mb-3"
        >
            1. INICIAR AR (Seguimiento de Imagen)
        </button>

        <!-- Botón 2: Android/WebXR Plane Detection (Simple/Universal Fallback) -->
        <button 
            id="ar-button-simple-fallback"
            onclick="initAR('plane-detection')"
            class="px-8 py-4 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg shadow-xl transition duration-200 transform hover:scale-105 mb-6"
        >
            2. INICIAR AR (Detección de Plano Simple)
        </button>

        <!-- Model Viewer para iOS Quick Look y Fallback (Siempre presente) -->
        <model-viewer 
            src="https://modelviewer.dev/shared-assets/models/NeilArmstrong.glb" 
            alt="Modelo de Neil Armstrong" 
            ar
            ar-modes="webxr quick-look scene-viewer"
            ar-placement="floor"
            camera-controls
            shadow-intensity="1"
            style="width: 0; height: 0; opacity: 0;"
            id="model-viewer-ios"
        >
        </model-viewer>
        
        <button 
            id="ar-button-ios"
            onclick="document.getElementById('model-viewer-ios').activateAR()"
            class="hidden px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-xl transition duration-200 transform hover:scale-105"
        >
            3. INICIAR AR (Quick Look - iOS NATIVO)
        </button>

        <p class="mt-4 text-gray-300 text-sm" id="platform-info">Detectando plataforma...</p>
        
        <!-- URL de la imagen que el usuario debe imprimir (ESTABLE) -->
        <p class="mt-4 text-gray-400 text-xs">
            Imagen objetivo (Solo para el modo 1): 
            <a href="https://placehold.co/500x500/000000/FFFFFF/png?text=AR+TARGET" target="_blank" class="text-blue-400 hover:text-blue-300">
                Placeholder AR TARGET (¡Imprimir a 15cm!)
            </a>
        </p>
    </div>

    <!-- 
        ============================================================
        Script: Lógica de WebXR (Seguimiento de Imagen y Detección de Plano)
        ============================================================
    -->
    <script>
        // --- CONSTANTES ---
        const MODEL_URL = "https://modelviewer.dev/shared-assets/models/NeilArmstrong.glb";
        const TARGET_IMAGE_URL = "https://placehold.co/500x500/000000/FFFFFF/png?text=AR+TARGET"; 
        const TARGET_IMAGE_SIZE_METERS = 0.15; // 15 cm
        
        // Variables de Three.js y WebXR
        let scene, camera, renderer;
        let xrSession = null;
        let xrRefSpace = null;
        let statusMessageEl;
        let armstrongModel = null;
        let targetImageBitmap = null; 
        let currentARMode = null; // 'image-tracking' or 'plane-detection'

        // --- Detección de Plataforma ---
        function isIOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        }

        // --- 0. Cargar el Modelo GLTF y la Imagen Objetivo ---
        async function loadAssets() {
            statusMessageEl.innerHTML = '<span class="loader"></span> Cargando modelo 3D y foto objetivo...';
            
            // 1. Cargar el Modelo GLTF
            const modelPromise = new Promise((resolve, reject) => {
                const loader = new THREE.GLTFLoader();
                loader.load(MODEL_URL, (gltf) => {
                    armstrongModel = gltf.scene;
                    // Reducir la escala
                    armstrongModel.scale.set(0.1, 0.1, 0.1); 
                    armstrongModel.visible = false; 
                    armstrongModel.traverse((node) => {
                        if (node.isMesh) {
                            node.castShadow = true;
                            node.receiveShadow = true;
                        }
                    });
                    resolve();
                }, undefined, reject);
            });

            // 2. Cargar Imagen Objetivo (Solo necesaria para Image Tracking)
            const imagePromise = fetch(TARGET_IMAGE_URL)
                .then(response => response.blob())
                .then(blob => createImageBitmap(blob))
                .then(bitmap => {
                    targetImageBitmap = bitmap;
                })
                .catch(error => {
                    console.warn('Advertencia: No se pudo cargar la imagen objetivo. El seguimiento de imágenes podría fallar, pero la detección de plano funcionará.', error);
                });

            try {
                await Promise.all([modelPromise, imagePromise]);
                statusMessageEl.textContent = 'Activos listos. Seleccione un modo AR.';
                document.getElementById('ar-button-image-tracking').disabled = false;
                document.getElementById('ar-button-simple-fallback').disabled = false;
            } catch (e) {
                console.error(e);
                statusMessageEl.textContent = `[ERROR DE ACTIVOS] ${e.message}. Verifique su conexión.`;
                document.getElementById('ar-button-image-tracking').disabled = true;
                document.getElementById('ar-button-simple-fallback').disabled = true;
            }
        }

        // --- 1. Inicialización de Three.js y Verificación de Plataforma ---
        function initThree() {
            const isApple = isIOS();
            statusMessageEl = document.getElementById('status-message');
            const imageTrackingButton = document.getElementById('ar-button-image-tracking');
            const simpleFallbackButton = document.getElementById('ar-button-simple-fallback');
            const iosButton = document.getElementById('ar-button-ios');
            const platformInfo = document.getElementById('platform-info');

            imageTrackingButton.disabled = true; 
            simpleFallbackButton.disabled = true;

            if (isApple) {
                // Configuración para iOS (Quick Look)
                imageTrackingButton.style.display = 'none';
                simpleFallbackButton.style.display = 'none';
                iosButton.classList.remove('hidden');
                statusMessageEl.textContent = 'Dispositivo iOS detectado. Por favor, use el botón verde.';
                platformInfo.textContent = 'Plataforma: iOS. Usa el botón 3.';
                return;
            }

            // Configuración para Android/WebXR
            platformInfo.textContent = 'Plataforma: Android/Otro. Usa el botón 1 o 2.';
            iosButton.style.display = 'none'; 
            
            // Inicialización de Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.xr.enabled = true; 
            document.body.appendChild(renderer.domElement);
            
            // Iluminación
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(0, 5, 2);
            scene.add(directionalLight);
            
            // El modelo se añade una vez, su visibilidad se controla en el bucle
            scene.add(armstrongModel);

            window.addEventListener('resize', onWindowResize, false);
            
            // Iniciar la carga de activos
            loadAssets();
        }

        function onWindowResize() {
            if (xrSession || isIOS()) return; 
            
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Objeto para manejar el raycasting en modo Detección de Plano
        let controller;
        let raycaster;
        let hitTestSource = null;
        let reticle; 


        // --- 2. Iniciación de WebXR (Unificada) ---
        async function initAR(mode) {
            currentARMode = mode;

            if (isIOS() && mode !== 'plane-detection') return; // iOS debe usar Quick Look

            if (!navigator.xr) {
                statusMessageEl.textContent = 'WebXR no soportado en este dispositivo/navegador.';
                return;
            }

            let sessionOptions = { requiredFeatures: ['local'] };
            let sessionFeature = 'local';
            let initialStatusText = '';

            if (mode === 'image-tracking') {
                if (!targetImageBitmap) {
                    statusMessageEl.textContent = 'Error: La imagen objetivo no se cargó. No se puede iniciar el Seguimiento de Imagen.';
                    return;
                }
                sessionOptions.trackedImages = [{ 
                    image: targetImageBitmap,
                    measuredWidthInMeters: TARGET_IMAGE_SIZE_METERS 
                }];
                initialStatusText = 'Cámara iniciada. Busque la imagen impresa "AR TARGET"...';
            } else if (mode === 'plane-detection') {
                sessionOptions.requiredFeatures.push('hit-test'); // Necesario para detectar planos
                sessionFeature = 'viewer';
                initialStatusText = 'Cámara iniciada. Mueva el teléfono para buscar una superficie plana.';
            }

            try {
                // Solicitar la sesión de AR
                xrSession = await navigator.xr.requestSession('immersive-ar', sessionOptions);

                renderer.xr.setSession(xrSession);
                xrRefSpace = await xrSession.requestReferenceSpace(sessionFeature); 
                
                document.getElementById('start-overlay').style.display = 'none';
                
                // Configuración específica para Detección de Plano
                if (mode === 'plane-detection') {
                    setupPlaneDetectionControls();
                }

                // INICIAR EL BUCLE DE ANIMACIÓN WEBXR
                renderer.setAnimationLoop(onXRFrame); 
                
                xrSession.addEventListener('end', onXRSessionEnd);

                statusMessageEl.textContent = initialStatusText;

            } catch (e) {
                console.error(`ERROR al iniciar WebXR AR (${mode}):`, e);
                let errorMessage = `Fallo al iniciar AR (${mode}): Revise permisos de cámara o compatibilidad.`;
                if (e.name === 'NotAllowedError') {
                    errorMessage = 'ERROR DE PERMISOS: Debe permitir el acceso a la cámara para iniciar AR.';
                }
                statusMessageEl.textContent = errorMessage;
            }
        }
        
        // --- 3. Configuración para Detección de Plano ---
        function setupPlaneDetectionControls() {
            // Reticle (el círculo que indica dónde se colocará el modelo)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.05, 0.1, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff, opacity: 0.8, transparent: true })
            );
            reticle.visible = false;
            scene.add(reticle);

            // Controlador para escuchar clics/taps
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // Raycaster para pruebas de impacto (hit-test)
            raycaster = new THREE.Raycaster();
        }
        
        function onSelect() {
            if (reticle.visible) {
                // Colocar el modelo en la posición del reticle
                armstrongModel.position.copy(reticle.position);
                armstrongModel.visible = true;
                // Una vez colocado, podemos deshabilitar el raycasting si solo queremos colocarlo una vez.
                // hitTestSource = null; 
                statusMessageEl.textContent = 'Modelo colocado en el plano.';
            }
        }


        // --- 4. Bucle de Renderizado WebXR ---
        function onXRFrame(time, frame) {
            
            if (currentARMode === 'image-tracking') {
                handleImageTracking(frame);
            } else if (currentARMode === 'plane-detection') {
                handlePlaneDetection(frame);
            }
            
            renderer.render(scene, camera);
        }

        // --- Lógica de Seguimiento de Imagen ---
        function handleImageTracking(frame) {
            
            const trackedImageSet = frame.getTrackedImageSet ? frame.getTrackedImageSet() : (frame.getTrackedImage ? frame.getTrackedImage(xrRefSpace) : []);
            
            let isImageTracked = false;
            
            if (trackedImageSet && trackedImageSet.length > 0) {
                const trackedImage = trackedImageSet[0]; 
                
                if (trackedImage.getIsTracked()) {
                    isImageTracked = true;
                    
                    const pose = frame.getPose(trackedImage.getAnchor().anchorSpace, xrRefSpace);
                    
                    if (pose) {
                        const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
                        armstrongModel.applyMatrix4(matrix);
                        armstrongModel.visible = true;
                        armstrongModel.position.y += armstrongModel.scale.y * 0.5; // Levantar
                        
                        statusMessageEl.textContent = '¡IMAGEN DETECTADA! Moviendo el modelo a la posición.';
                    }
                }
            }

            // Ocultar el modelo si la imagen no está siendo rastreada
            if (!isImageTracked) {
                if (armstrongModel) {
                    armstrongModel.visible = false;
                    statusMessageEl.textContent = 'Cámara iniciada. Busque la imagen impresa "AR TARGET"...';
                }
            }
        }
        
        // --- Lógica de Detección de Plano ---
        function handlePlaneDetection(frame) {
            if (!hitTestSource) {
                // Si aún no tenemos el hit test source, solicitamos uno
                frame.getSession().requestHitTestSource({ space: xrRefSpace })
                    .then(source => {
                        hitTestSource = source;
                        // Para evitar que el usuario se confunda con el modelo del tracking de imagen
                        armstrongModel.visible = false;
                        reticle.visible = false;
                    })
                    .catch(error => {
                        console.error('Error al solicitar hit test source:', error);
                        statusMessageEl.textContent = 'ERROR: No se pudo iniciar la detección de plano. Intente de nuevo.';
                        // Finalizar la sesión si hay un error grave.
                        xrSession.end();
                    });
            }

            if (hitTestSource) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);

                if (hitTestResults.length > 0) {
                    // Si encontramos un plano
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(xrRefSpace);
                    
                    reticle.visible = true;
                    reticle.position.setFromMatrixPosition(new THREE.Matrix4().fromArray(pose.transform.matrix));

                    statusMessageEl.textContent = 'Plano detectado. Toque la pantalla para colocar el modelo.';
                } else {
                    // Si no encontramos un plano
                    reticle.visible = false;
                    statusMessageEl.textContent = 'Mueva el teléfono lentamente para escanear la superficie.';
                }
            }
        }


        // --- 5. Manejador de Finalización de Sesión ---
        function onXRSessionEnd() {
            renderer.setAnimationLoop(null); 
            
            xrSession = null;
            xrRefSpace = null;
            hitTestSource = null;
            
            if (armstrongModel) {
                armstrongModel.visible = false;
            }
            if (reticle) {
                reticle.visible = false;
            }

            document.getElementById('start-overlay').style.display = 'flex';
            statusMessageEl.textContent = 'Sesión AR terminada. Seleccione un modo AR para comenzar de nuevo.';
        }

        // Iniciar al cargar la ventana
        window.onload = function() {
            initThree(); 
        };
    </script>

</body>
</html>
