<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR: Colocación de Objetos</title>
    
    <!-- Tailwind CSS para estilos de UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librerías de WebAR -->
    <!-- Usaremos A-Frame para 3D y su soporte nativo para WebXR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>

    <style>
        /* Estilos específicos para la UI */
        #status-message {
            z-index: 1000;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }

        /* Estilo para el overlay de inicio */
        #ar-overlay {
            z-index: 1010;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            backdrop-filter: blur(5px);
        }

        /* Asegura que la escena ocupe toda la pantalla */
        a-scene {
            height: 100vh;
            width: 100vw;
        }

        /* Animación de pulso para el cursor */
        .cursor-sphere {
            opacity: 0.6;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.1);
            }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- 
        ============================================================
        Componente JavaScript para la Lógica AR con WebXR nativo
        ============================================================
    -->
    <script>
        // Componente para la lógica de colocación de objetos usando WebXR (Hit Testing)
        AFRAME.registerComponent('webxr-placement-logic', {
            init: function () {
                this.sceneEl = this.el;
                this.statusEl = document.getElementById('status-message');
                this.cursorEl = document.getElementById('ar-cursor');
                this.objectCount = 0;
                this.hitTestState = false; // Estado para saber si tenemos un resultado de hit-test

                // Clonar el objeto cursor (template) y ponerlo en la escena para manipularlo
                this.template = document.getElementById('object-template').cloneNode(true);
                this.template.id = 'template-clone';
                this.cursorEl.appendChild(this.template);
                this.template.setAttribute('visible', 'false');

                // Escucha el evento cuando A-Frame encuentra una intersección AR (hit-test)
                this.sceneEl.addEventListener('ar-hit-test-start', (evt) => {
                    this.statusEl.textContent = 'Intentando encontrar superficies...';
                });

                // Este evento se dispara continuamente cuando WebXR encuentra un plano
                this.sceneEl.addEventListener('ar-hit-test-result', (evt) => {
                    if (evt.detail.intersection) {
                        // Transformar el hit-test (intersección) en una posición
                        const position = evt.detail.intersection.point;
                        
                        // Mueve el cursor a la posición detectada
                        this.template.setAttribute('position', position);
                        this.template.setAttribute('visible', 'true');
                        this.statusEl.textContent = 'Superficie detectada. Toque la pantalla para colocar.';
                        this.hitTestState = true;
                    } else {
                        // Si no hay intersección
                        this.template.setAttribute('visible', 'false');
                        this.statusEl.textContent = 'Mueva el dispositivo para escanear y encontrar superficies...';
                        this.hitTestState = false;
                    }
                });

                // Escucha el clic (toque) para colocar el objeto
                this.sceneEl.addEventListener('click', this.placeObject.bind(this));
            },
            
            // Función para colocar el objeto 3D
            placeObject: function(evt) {
                // Solo colocamos si hay un plano detectado (cursor visible)
                if (this.hitTestState) {
                    const newObject = document.createElement('a-entity');
                    const cursorPosition = this.template.getAttribute('position');
                    
                    // Configuración del objeto (Caja giratoria azul)
                    newObject.setAttribute('geometry', 'primitive: box; height: 0.2; width: 0.2; depth: 0.2');
                    newObject.setAttribute('material', 'color: #3b82f6; opacity: 0.9');
                    // Elevar el objeto un poco sobre la superficie para evitar Z-fighting
                    newObject.setAttribute('position', `${cursorPosition.x} ${cursorPosition.y + 0.1} ${cursorPosition.z}`); 
                    newObject.setAttribute('shadow', '');
                    newObject.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
                    
                    this.sceneEl.appendChild(newObject);
                    this.objectCount++;
                    this.statusEl.textContent = `Objeto ${this.objectCount} colocado. Siga escaneando.`;
                }
            }
        });

        // Lógica para iniciar la sesión AR al hacer clic en el botón
        function startAR() {
            const scene = document.getElementById('ar-scene');
            const overlay = document.getElementById('ar-overlay');
            const statusEl = document.getElementById('status-message');
            
            // Intenta entrar al modo AR de WebXR, que maneja la activación de la cámara.
            // Esto es mucho más robusto que solo scene.play()
            if (scene.hasWebXR && scene.hasWebXR.isPresenting) {
                // Ya estamos en AR, solo ocultar el overlay (caso de fallback)
                overlay.style.display = 'none';
            } else {
                // 1. Oculta el overlay antes de intentar entrar a AR
                overlay.style.display = 'none';
                statusEl.textContent = 'Esperando permiso de la cámara...';
                
                // 2. Intenta entrar al modo AR. A-Frame se encarga de pedir el permiso de cámara.
                scene.enterAR();
            }
        }

        // Configuración inicial de A-Frame
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.getElementById('ar-scene');
            
            // Escucha el evento de A-Frame cuando se entra al modo AR (cámara activa)
            scene.addEventListener('enter-vr', function () {
                if (this.is('ar-mode')) {
                    document.getElementById('status-message').textContent = '¡Cámara activada! Mueva el móvil para escanear.';
                }
            });
            
            scene.addEventListener('ar-hit-test-unavailable', function () {
                document.getElementById('status-message').textContent = 'ERROR: La Realidad Aumentada no está disponible en este dispositivo/navegador.';
            });

            // Asocia la función startAR al botón
            document.getElementById('start-ar-button').addEventListener('click', startAR);
        });
    </script>

    <!-- 
        ============================================================
        Estructura de la Escena A-Frame (El "Mundo 3D")
        ============================================================
    -->
    <a-scene 
        id="ar-scene"
        embedded 
        webxr-placement-logic 
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
        
        <!-- Configuración de WebXR: Requerir la prueba de impacto (hit-test) para AR -->
        webxr="requiredFeatures: [hit-test, local-floor]; optionalFeatures: [dom-overlay, unmanaged-fading]; referenceSpaceType: local-floor">
        
        <!-- Luces: Imprescindible en 3D -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8; castShadow: true" position="-1 2 1"></a-entity>
        
        <!-- Cámara: Necesaria, A-Frame la gestiona en modo AR -->
        <a-camera user-height="0"></a-camera>

        <!-- EL CURSOR DE PUNTERÍA AR (Usamos un objeto 'a-entity' como contenedor) -->
        <a-entity 
            id="ar-cursor" 
            position="0 0 -0.5">
            
            <!-- Template del objeto que se usará como cursor (un anillo verde) -->
            <a-entity 
                id="object-template"
                geometry="primitive: torus; radius: 0.05; radiusTubular: 0.005; segmentsRadial: 16; segmentsTubular: 12"
                material="color: #4ade80; shader: flat"
                rotation="90 0 0" 
                class="cursor-sphere">
            </a-entity>
        </a-entity>

    </a-scene>

    <!-- 
        ============================================================
        INTERFAZ DE USUARIO (UI)
        ============================================================
    -->

    <!-- Overlay de inicio: El botón de clic explícito -->
    <div id="ar-overlay">
        <div class="p-6 max-w-sm bg-white rounded-xl shadow-2xl space-y-4 transform scale-100 md:scale-110 transition duration-300">
            <h1 class="text-2xl font-bold text-gray-900">Iniciar AR</h1>
            <p class="text-gray-600">Esta versión utiliza la función WebXR nativa para la máxima compatibilidad.</p>
            <p class="text-sm text-red-500 font-semibold">Toca el botón y asegúrate de aceptar el permiso de la cámara.</p>
            <button 
                id="start-ar-button" 
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg transform hover:scale-105">
                INICIAR REALIDAD AUMENTADA
            </button>
            <p class="text-xs text-gray-500 mt-4">Si falla, verifique que su navegador esté actualizado (Chrome/Safari).</p>
        </div>
    </div>

    <!-- Mensaje de estado en la parte inferior de la pantalla -->
    <div id="status-message" class="text-sm rounded-t-lg shadow-2xl">
        Esperando inicio de AR...
    </div>

</body>
</html>
