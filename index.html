<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindAR - AR con Chequeo de Sondeo Definitivo</title>
    
    <!-- Tailwind CSS para estilos de UI -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Librerías de AR (A-Frame 1.5.0 y MindAR 1.2.5) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* Estilos generales para asegurar el viewport completo */
        html, body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: black;
            width: 100vw;
            height: 100vh;
        }
        
        a-scene {
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important;
            width: 100% !important;
            height: 100% !important; 
            z-index: 10;
        }

        /* Overlay de inicio (para gestionar permisos) */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        /* Mensaje de estado para feedback al usuario */
        #status-message {
            z-index: 1000;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(6, 182, 212, 0.9);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            pointer-events: none;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Overlay de inicio -->
    <div id="start-overlay">
        <h1 class="text-3xl font-bold text-white mb-6">MindAR: Inicio por Sondeo Manual</h1>
        <p class="text-gray-300 mb-8 text-lg max-w-md">
            Verificando la carga del componente AR. Esto se activará tan pronto como la librería esté lista.
        </p>
        <p class="text-yellow-400 mb-4 text-sm font-semibold">
            ⚠️ Marcador de prueba: Enfoque la imagen de la tarjeta de póker (Joker).
        </p>
        
        <button 
            id="ar-button-start"
            class="px-10 py-5 bg-cyan-600 hover:bg-cyan-700 text-white font-extrabold text-xl rounded-xl shadow-2xl transition duration-200 transform hover:scale-105 rounded-xl disabled:opacity-50"
            disabled
        >
            INICIAR CÁMARA Y AR
        </button>
    </div>

    <!-- Mensaje de estado flotante -->
    <div id="status-message">
        Esperando la definición de la librería MindAR...
    </div>

    <!-- Escena de A-Frame con MindAR -->
    <a-scene 
        id="ar-scene"
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false;"
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights: true"
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        style="display: none;"
    >
        <!-- DEFINICIÓN DE ASSETS (IMAGEN Y MODELO 3D) -->
        <a-assets>
            <img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" crossorigin="anonymous"/>
            <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf" crossorigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- CRÍTICO: Definición de la cámara MindAR -->
        <a-camera mindar-image-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Marcador de IMAGEN: Target 0 (la tarjeta de póker) -->
        <a-entity mindar-image-target="targetIndex: 0" id="mindar-target">
            
            <!-- Plano para visualizar la imagen del marcador, útil para debug -->
            <a-plane src="#card" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>

            <!-- Modelo 3D con animación, usando los assets del ejemplo -->
            <a-gltf-model 
                rotation="0 0 0 " 
                position="0 0 0.1" 
                scale="0.005 0.005 0.005" 
                src="#avatarModel"
                animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"
            ></a-gltf-model>

        </a-entity>
    </a-scene>

    <script>
        // Obtener referencias a elementos del DOM
        const sceneEl = document.getElementById('ar-scene');
        const statusMessage = document.getElementById('status-message');
        const overlayEl = document.getElementById('start-overlay');
        const targetEl = document.getElementById('mindar-target');
        const startButton = document.getElementById('ar-button-start');
        
        // Contador para evitar bucles infinitos
        let attempts = 0;
        const maxAttempts = 100; // 100 intentos * 100ms = 10 segundos

        /**
         * Función asíncrona para iniciar MindAR
         */
        async function startAR() {
            // Deshabilitar botón para evitar reintentos 
            startButton.disabled = true;
            statusMessage.textContent = 'Iniciando proceso de cámara (esperando permisos)...';

            // Ocultar overlay y mostrar la escena AR
            overlayEl.style.display = 'none';
            sceneEl.style.display = 'block';

            // Damos un pequeño respiro para el reflow del DOM
            await new Promise(resolve => setTimeout(resolve, 50)); 
            
            // Requerir el sistema de la escena (debería existir si el polling funcionó)
            const mindarSystem = sceneEl.systems['mindar-image'];
            
            if (!mindarSystem) {
                 // Si falla, es un error fatal de la instancia de A-Frame o bloqueo post-polling
                 let fatalError = '⚠️ ERROR CRÍTICO POST-CLICK: El sistema MindAR (instancia de A-Frame) NO se encontró. Bloqueo interno.';
                 statusMessage.innerHTML = fatalError;
                 statusMessage.style.backgroundColor = 'rgba(239, 68, 68, 0.9)'; 
                 console.error(fatalError);
                 return;
            }
            
            try {
                // Iniciar el sistema MindAR
                console.log("MindAR System encontrado. Intentando iniciar...");
                await mindarSystem.start(); 
                
            } catch (error) {
                // Manejo de errores de inicio (típicamente permisos de cámara)
                let errorMessage = `
                    ⚠️ ERROR DE CÁMARA/PERMISOS: Falló al iniciar el video.
                    <br>
                    Esto ocurre si se niega el permiso o si el navegador lo bloquea sin preguntar.
                `;
                statusMessage.innerHTML = errorMessage;
                statusMessage.style.backgroundColor = 'rgba(239, 68, 68, 0.9)'; 
                console.error("MindAR System Start Error (Permisos/Hardware):", error);
            }
        }

        /**
         * Lógica de sondeo (Polling) para verificar la carga global de MindAR.
         */
        function checkMindARComponentStatus() {
            // Chequea si AFRAME existe y si el componente 'mindar-image' ha sido definido
            const isMindARLoaded = typeof AFRAME !== 'undefined' && 
                                   typeof AFRAME.components !== 'undefined' &&
                                   typeof AFRAME.components['mindar-image'] !== 'undefined';
            
            attempts++;

            if (isMindARLoaded) {
                // Éxito: Componente MindAR detectado.
                clearInterval(mindARCheckInterval); // Detener el sondeo
                statusMessage.textContent = 'Sistema AR detectado. Presione INICIAR CÁMARA.';
                startButton.disabled = false;
                statusMessage.style.backgroundColor = 'rgba(16, 185, 129, 0.9)'; // Verde éxito
                console.log(`MindAR Component Check: ¡Detectado con éxito en ${attempts} intentos!`);
            } else if (attempts >= maxAttempts) {
                // Fallo: Se alcanzó el límite de tiempo.
                clearInterval(mindARCheckInterval); // Detener el sondeo
                statusMessage.innerHTML = '⚠️ ERROR FATAL: El componente MindAR no se cargó después de 10 segundos. Confirme que las URLs de los scripts son accesibles.';
                statusMessage.style.backgroundColor = 'rgba(239, 68, 68, 0.9)'; 
                console.error("Error: Límite de tiempo excedido. MindAR component definition not found.");
            }
        }

        // 1. Adjuntar la función de inicio al botón
        startButton.addEventListener('click', startAR);

        // 2. Iniciar el sondeo cada 100ms.
        const mindARCheckInterval = setInterval(checkMindARComponentStatus, 100);

        // --- Oyentes de Eventos MindAR/A-Frame para feedback ---
        
        sceneEl.addEventListener('mindar-start', function() {
            statusMessage.textContent = 'Cámara activa. ¡Busque el marcador de la tarjeta!';
            statusMessage.style.backgroundColor = 'rgba(6, 182, 212, 0.9)';
        });
        
        targetEl.addEventListener('targetFound', function() {
            statusMessage.textContent = '¡MARCADOR DETECTADO! Modelo 3D visible.';
            statusMessage.style.backgroundColor = 'rgba(168, 85, 247, 0.9)';
        });

        targetEl.addEventListener('targetLost', function() {
            statusMessage.textContent = 'Marcador perdido. Siga enfocando la tarjeta.';
            statusMessage.style.backgroundColor = 'rgba(6, 182, 212, 0.9)';
        });
    </script>
</body>
</html>
