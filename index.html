<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR: Colocación de Objetos a Prueba de Fallos</title>
    
    <!-- Tailwind CSS para estilos de UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librerías de WebAR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    
    <style>
        /* Estilos generales */
        body { margin: 0; padding: 0; }

        /* Estilos específicos para la UI */
        #status-message {
            z-index: 1000;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem;
            text-align: center;
            font-family: 'Inter', sans-serif;
            transition: opacity 0.3s ease;
        }

        /* Estilo para el overlay de inicio */
        #ar-overlay {
            z-index: 1010;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            backdrop-filter: blur(5px);
        }

        /* Asegura que la escena ocupe toda la pantalla */
        a-scene {
            height: 100vh;
            width: 100vw;
            --aframe-scene-button-display: none; 
        }

        /* Estilo para el cursor visual */
        #ar-cursor-visual {
            opacity: 0.8;
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- 
        ============================================================
        Componente JavaScript para la Lógica de Colocación
        ============================================================
    -->
    <script>
        // Componente para manejar la colocación al hacer clic o tocar
        AFRAME.registerComponent('placement-handler', {
            init: function () {
                this.sceneEl = this.el;
                this.statusEl = document.getElementById('status-message');
                this.objectCount = 0;
                this.arModeActive = false;
                this.cursorEl = document.getElementById('ar-cursor-visual');
                
                // 1. Escuchar cuando el modo AR se activa (entrada de WebXR)
                this.sceneEl.addEventListener('enter-vr', (evt) => {
                    if (this.sceneEl.is('ar-mode')) {
                        this.arModeActive = true;
                        this.statusEl.textContent = 'Mueva el móvil para escanear y encontrar superficies...';

                        // Usamos el evento 'select' de WebXR para la interacción (toque/clic)
                        this.sceneEl.addEventListener('select', this.placeObject.bind(this)); 
                        console.log('DEBUG: Listener "select" (WebXR) adjuntado a la escena.');
                    }
                });
                
                // 2. Escuchar los eventos de 'ar-hit-test' para actualizar el estado del cursor
                this.cursorEl.addEventListener('ar-hit-test-update', (evt) => {
                    console.log('DEBUG: Evento ar-hit-test-update disparado. Éxito:', evt.detail.successful);
                    
                    // Si el hit-test fue exitoso, el cursor es visible y podemos colocar
                    if (evt.detail.successful) {
                        this.statusEl.textContent = 'Superficie detectada (cursor verde). Toque la pantalla para colocar.';
                    } else {
                        this.statusEl.textContent = 'Mueva el móvil para escanear y encontrar superficies...';
                    }
                });
            },

            // Función para colocar el objeto 3D
            placeObject: function(evt) {
                if (!this.arModeActive) return;

                // Verificamos si el cursor visual está visible (indicador de hit-test exitoso)
                const isCursorVisible = this.cursorEl.getAttribute('visible');

                if (isCursorVisible) {
                    // Obtenemos la posición actual del cursor visual
                    const position = this.cursorEl.object3D.position;
                    
                    const newObject = document.createElement('a-entity');
                    
                    // Configuración del objeto (una caja azul que rota)
                    newObject.setAttribute('geometry', 'primitive: box; height: 0.2; width: 0.2; depth: 0.2');
                    newObject.setAttribute('material', 'color: #3b82f6; opacity: 0.9');
                    // Usamos la posición del cursor (con un pequeño offset en Y)
                    newObject.setAttribute('position', `${position.x} ${position.y + 0.1} ${position.z}`); 
                    newObject.setAttribute('shadow', '');
                    newObject.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
                    
                    this.sceneEl.appendChild(newObject);
                    this.objectCount++;
                    this.statusEl.textContent = `Objeto ${this.objectCount} colocado. ¡Siga creando!`;
                } else {
                    this.statusEl.textContent = '¡Necesita detectar una superficie! Mueva el móvil.';
                }
            }
        });

        // Lógica para iniciar la sesión AR al hacer clic en el botón
        function startAR() {
            const scene = document.getElementById('ar-scene');
            const overlay = document.getElementById('ar-overlay');
            const statusEl = document.getElementById('status-message');
            
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                statusEl.textContent = 'Activando cámara y detección de superficies...';
                // Inicia la sesión AR
                scene.enterAR();
            }, 300); 
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('start-ar-button').addEventListener('click', startAR);
        });
    </script>

    <!-- 
        ============================================================
        Estructura de la Escena A-Frame (El "Mundo 3D")
        ============================================================
    -->
    <a-scene 
        id="ar-scene"
        embedded 
        placement-handler 
        renderer="logarithmicDepthBuffer: true; antialias: true" 
        vr-mode-ui="enabled: false"
        
        <!-- FIX CLAVE: Cambiamos de 'local-floor' a 'local' para un espacio de referencia más general y compatible. -->
        webxr="requiredFeatures: hit-test, local; referenceSpaceType: local">
        
        <!-- Luces: Imprescindible para ver objetos -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8; castShadow: true" position="-1 2 1"></a-entity>
        
        <!-- Cámara: Posicionada para modo AR -->
        <a-camera user-height="0" position="0 0 0" rotation="0 0 0">
        </a-camera>
        
        <!-- 
            CURSOR VISUAL (Entidad independiente)
            El componente ar-hit-test lo posiciona automáticamente en el mundo. 
        -->
        <a-entity 
            id="ar-cursor-visual"
            geometry="primitive: torus; radius: 0.05; radiusTubular: 0.005; segmentsRadial: 16; segmentsTubular: 12"
            material="color: #4ade80; shader: flat"
            rotation="90 0 0" 
            visible="false"
            
            <!-- Componente clave: Realiza el hit-test y actualiza la posición del cursor en el mundo -->
            ar-hit-test="doHitTest: true; targetEl: #ar-cursor-visual">
        </a-entity>

    </a-scene>

    <!-- 
        ============================================================
        INTERFAZ DE USUARIO (UI)
        ============================================================
    -->

    <div id="ar-overlay" class="transition duration-300 ease-in-out">
        <div class="p-6 max-w-sm bg-white rounded-xl shadow-2xl space-y-4 transform scale-100 md:scale-110">
            <h1 class="text-2xl font-bold text-gray-900">Iniciar AR</h1>
            <p class="text-gray-600">Sistema optimizado con el espacio de referencia `local` para mejor compatibilidad con dispositivos.</p>
            <p class="text-sm text-red-500 font-semibold">Mueva el móvil lentamente para escanear el entorno. Cuando vea el cursor verde, toque la pantalla para colocar un objeto.</p>
            <button 
                id="start-ar-button" 
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg transform hover:scale-105">
                INICIAR REALIDAD AUMENTADA
            </button>
        </div>
    </div>

    <div id="status-message" class="text-sm rounded-t-lg shadow-2xl">
        Esperando inicio de AR...
    </div>

</body>
</html>
